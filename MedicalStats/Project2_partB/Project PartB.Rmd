---
title: "MAS61002 Project Part B  \n Registration Number: 210138744"
geometry: "left=1cm,right=1cm,top=2cm,bottom=2cm"
header-includes: \usepackage{relsize}
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(survival)
library(tidyverse)
library(ggplot2)
data <- load("Data/E_PartB_data.RData")
```

# Question 1

# Question 1.1
```{r include=TRUE, results='asis', figures-side, fig.show="hold", out.width="50%"}
library(knitr) # for prettier tables
library(pander) #for adding pandoc headers
library(ggfortify) # so we can use fortify to create a datatable required for knitr
options(digits = 3) # let's keep output to sensible number of places
trialA <- q1dat %>% filter(drug == "A")
trialB <- q1dat %>% filter(drug == "B")
trialA.sv <- Surv(time=trialA$time, event=trialA$status, type="right")
trialASurv <- survfit(trialA.sv ~ 1, data = trialA)
tableA <- fortify(trialASurv) %>% rename(survival=surv, "lower 95% CI"=lower, "upper 95% CI"= upper) %>%
            select(1, 2, 3, 5, 6, 8, 7)
pandoc.header(list("Kaplan-Meier Estimate of Survivor Function for trial drug A"), level = 2)
print(kable(tableA))
trialB.sv <- Surv(time=trialB$time, event=trialB$status, type="right")
trialBSurv <- survfit(trialB.sv ~ 1, data = trialB)
tableB <- fortify(trialBSurv) %>% rename(survival=surv, "lower 95% CI"=lower, "upper 95% CI"= upper)%>%
            select(1, 2, 3, 5, 6, 8, 7)
pandoc.header(list("Kaplan-Meier Estimate of Survivor Function for trial drug B"), level = 2)
print(kable(tableB))

par(mar = c(4, 4, .1, .1))
plot(trialASurv, xlab ="months", ylab = "probablity of survival")
title("Kaplan-Meier  plot of trial A drug", line= -1 )
plot(trialBSurv, xlab ="months", ylab = "probablity of survival")
title( "Kaplan-Meier  plot of trial B drug", line= -1 )


```


# Question 1.2
The plot of drug A shows:
* The median survival time was between 13.4 months (p=0.52) and 19.1 months (p=0.44).
* The last remaining (uncensored) patient died at 52.4 months.
* The trial consisted of 20 patients of whom 14 dies and 6 were censored.

The plot of drug B shows:
* That the median survival time was between 5.0 months (p=0.55) and 5.7 months (p=0.50) months.
* The last remaining (uncensored) patient died at 19.1 months.
* The trial consisted of 25 patients of whom 17 died and 8 were censored.

The plot of A is over a longer term greater than 50 months (52.4) so the gradient over time is less pronounces than plot B which is under 20 months (19.1).  However as the y-axis are shown to different scales this is less pronounced visbility than it would be if plotted together on a single plot.

The confidence interval is wide on both plots, we can expect this given the small number of patients, n=25 and n=20, plus the proprtionally high numbers of censored patients, 8 and 6 respectively.  To reduce the confidence interval a larger number of patients and more frequent assessments can be used.  It appears that the confidence intervals overlap to a large extent, however as this is the focus of Q1.3 we will consider that there.

# Question 1.3
A simple (albeit less accurate) approach to considering this question is to ask at the quartiles does the time periods overlap between groups.  If the time periods do overlap between the groups then we have insufficent evidence that the groups differ.  However if the time periods do not overlap then that points to their being potential differences in the groups.  Tabulaing this data we get:

Quartile Drug Probability of survival Conf. Int.   Time (Months)
-------- ---- ----------------------- ------------ -----------
Q3        A    0.78 - 0.72            0.10 - 0.54  3.7 - 4.3
Q3        B    0.77 - 0.71            0.97 - 0.55  1.3 - 2.0
Q2        A    0.52 - 0.44            0.84 - 0.25  13.4 - 19.1
Q2        B    0.55 - 0.50            0.82 - 0.32  5.0 - 5.7
Q1        A    0.27 - 1.18            0.66 - 0.05  34.0 - 37.1
Q1        B    0.25 - 0.19            0.57 - 0.07  12.0 - 15.6


It is apparent from the output that for each quartile of the time periods overlap between the drug trials.  This allows us to believe there may be a difference between the trials (we only need one non-overlap not all).  To evaluate this probability we need to use a statistical test based on a chi-square test (which I believe medics are taught).  Running the following R code allows us to evaluate this claim, generating a probability `trial.p` as to whether the drug trials are equal.  Using `survdiff` function we are specifying our model using `Surv` with `time`, `event` which is named `status` in our data and refers to whether the event is censored or not; `~ drug` means assess between the different groups whilst `data` is the dataframe which we are using to pass in our data.
```{r include=TRUE}
options(digits = 3)
trial.diff <-  survdiff(Surv(time=time, event=status, type="right") ~ drug, data=q1dat)
trial.diff
trial.p <- format(1 - pchisq(trial.diff$chisq, length(trial.diff$n) - 1), digits = 3)
print(str_glue("The probability of the drug trials being equal is: {trial.p}"))
```
From the chiquare test that the survdiff function performs for us we can see that there is some/moderate evidence (p=0.01) at the 95\% probability level to support the drugs having a difference in survival times. The 95\% probability level means that were we to rerun the trial for a total of 20 times then we would expect on average for 19 of the trials to reach this conculsion.  The chisquare test calculates probability by comparing the expected values against the observed values.

Hence I believe the clinician is mistaken to state that there isn't any difference in survival times for those taking drug A and those taking drug B. As there is moderate evidence (p=0.01) suggesting a difference between the drugs.  Looking at the plots and the data given we know there is moderate evidence of a difference then drug A typically leads to a longer survival time than drug B.  This can be seen in the quartile tabulations done above, so at quarter two (the median) life expectancy of drug A is: 13.4 - 19.1 months versus drug B which is 5.0 - 5.7 months.



# Question 2

# Question 2.1
```{r include=TRUE}
lungcancer.sv <- Surv(time=q2dat$time, event=q2dat$stat, type="right")
model <- lungcancer.sv ~ as.factor(trea) + as.factor(sex) + as.factor(exer) + as.factor(smok) + age
lungcancer.regexp <- survreg(model, dist="exponential", data=q2dat)
summary(lungcancer.regexp)
```
Therefore the accelerated failure time model with an exponential failure time distribution and explanatory variables **x** is:

$$ \begin{aligned}
S(t;\mathbf{x}) &= exp\{{-t\: exp(-(\beta_0 + \beta_1x_{1} + \beta_2x_{2} + \beta_3x_{3} + \beta_4x_{4} + \beta_5x_{5}))}\}\\
&= exp\{{-t\: exp(-(\beta_0 + \beta_1x_{trea} + \beta_2x_{sex} + \beta_3x_{exer} + \beta_4x_{smok} + \beta_5x_{age}))}\}\\
&= exp\{{-t\: exp(-(0.5017 + 0.8144x_{trea} - 0.5328x_{sex} - 0.2566x_{exer} - 0.8821x_{smok} - 0.0113x_{age}))}\}\\
&= exp\{{-t\: exp(-0.5017 - 0.8144x_{trea} + 0.5328x_{sex} + 0.2566x_{exer} + 0.8821x_{smok} + 0.0113x_{age})}\}\\
& \text{However age (p=0.15) and exercise (p=0.18) are not significant in the model excluding those from the model gives:}\\
&= exp\{{-t\: exp(-0.5017 - 0.8144x_{trea} + 0.5328x_{sex} + 0.8821x_{smok})}\}\\
\end{aligned}
$$

Variable     Coding
--------    -------------------------------------------------------------
sex         0 = male; 1 = female
exer        0 = some exercise; 1 = rarely exercise
smok        0 = not current smoker; 1 = current smoker
trea        0 = treatment A; 1 = treatment B
age         age of patient centred on 50 years (i.e. 60 years old is 10)
t           survival time (years)

Given the coding then the model will include the treatment variable for those on treatment B and exclude it for those on treatment A.  Let $S_a(t;\mathbf{x})$ be the model for treatment A and $S_b(t;\mathbf{x})$ the model for treatment B, then this gives:

$$ \begin{aligned}
S_a(t;\mathbf{x}) &= exp\{{-t\: exp(-0.5017 + 0.5328x_{sex} + 0.8821x_{smok})}\}\\
S_b(t;\mathbf{x}) &= exp\{{-t\: exp(-0.5017 - 0.8144x_{trea} + 0.5328x_{sex} + 0.8821x_{smok})}\}\\
\end{aligned}
$$

# Question 2.2

As $z = \beta_1 /(std. error) = 4.29$ and $4.29 > 1.96$ then there is overwhelming evidence that the treatment has an effect. Considering the proprtional hazards related to treatment A and B we know that $h(t; x |x_1=1)/h(t; x | x_1=0) = exp\:\beta_1$.  As $\beta_1 > 0$ then treatment B ($x_1 = 1$) increases the hazard relative to treatment A ($x_1 = 0$).

$$\begin{aligned}
\text{The 95}\% \text{ confidence interval for treatment }\beta_1\text{ is: }&= \hat{\beta_1} \pm 1.96 \times s.e(\hat{\beta_4}) \\
&= 0.8144 \pm 1.96 \times 0.1898 \\
&= (0.44, 1.19)
\end{aligned}
$$

The hazard function $h(t; \mathbf{x}) = exp\{\mathbf{B}'\mathbf{x}\}h_0(t)$ where $h_0(t) is the baseline hazard function.  Let $h_a(t; \mathbf{x})$ and $h_b(t; \mathbf{x})$ be the respective hazard functions of treatment A and treatment B, which are:
$$
\begin{aligned}
h_a(t;\mathbf{x}) &= h_0(t)exp\{\beta_2x_2 + \beta_4x_4  \}\\
h_b(t;\mathbf{x}) &= h_0(t)exp\{\beta_1\times 1 + \beta_2x_2 + \beta_4x_4 \}\\
\end{aligned}
$$

Then the hazard ratio of treatment A versus treatment B is given by:
$$
\begin{aligned}
\frac{h_b(t;\mathbf{x})}{h_a(t;\mathbf{x})}  &= \frac{h_0(t)exp\{\beta_1\times 1 + \beta_2x_2 + \beta_4x_4 \}}{h_0(t)exp\{ \beta_1\times 0 + \beta_2x_2 + \beta_4x_4 \}}\\
 &= \frac{h_o(t)exp\{\beta_1\times 1\}}{h_0(t)} \\
 &=exp\{\beta_1\}\\
 &= exp\{0.8144\} \\
 &= 2.26 \\
\end{aligned}
$$
The 95$\%$ confidence interval for the hazard ratio of treatment A versus treatment B ($exp\{\beta_1\}$) is given by:
$$
\begin{aligned}
95\% \text{ CI } &= (exp\{\beta_1 - 1.96*s.e(\beta_1)\}, exp\{\beta_1 + 1.96*s.e(\beta_1)\})\\
&= (exp\{0.8144 - 1.96*0.1898\}, exp\{0.8144 + 1.96*0.1898\})\\
&= (1.56, 3.28)
\end{aligned}
$$
Interpreting the confidence interval of (1.56, 3.28) means that at the $95\%$ confidence level that the hazard for patients on treatment B could be anywhere between just over one and half times and just over three and a quarter times that of the hazard for treatment A.

# Question 2.3
The median is calculated as follows where $median_a$ and $median_b$ be the median survival times for treatments A and B respectively. The reader is reminded that age and exercise were not significant in the model so were not included in the median life expectancy calculations either.
$$
\begin{aligned}
\text{median}_a &= log(2)exp\{\beta_0 + \beta_1\times x_1 + \beta_2\times x_2  + \beta_4\times x_4 \} \\
&= log(2)exp\{\beta_0 + \beta_1\times x_{treat} + \beta_2\times x_{sex}  + \beta_4\times x_{smok} \}\\
&= log(2)exp\{0.5017 + 0.8144\times 1 - 0.5328\times x_{sex} - 0.8821\times x_{smok} \}\\
&= log(2)exp\{1.3161 - 0.5328\times x_{sex} - 0.8821\times x_{smok} \}\\
\\
\text{median}_b &= log(2)exp\{\beta_0 + \beta_2\times x_{sex}  + \beta_4\times x_{smok} \}\\
&= log(2)exp\{0.5017 - 0.5328\times x_{sex} - 0.8821\times x_{smok} \}
\end{aligned}
$$
The question asks "using the R output" therefore we must tabulate the possible answers.  Note that given the short median times in years, it was considered useful to list the median life expectancies in both years and months.

## Table of Median life expectancy for treatments A and B
Scenario                   Median A (years)   Median B (years)  Median A (months) Median B (months)
-------------------------- ------------------ ----------------- ----------------- ----------------
$x_{sex}= 1, x_{smok} = 1$ 0.63               0.28              7.5               3.3
$x_{sex}= 1, x_{smok} = 0$ 1.52               0.67              18.2              8.1
$x_{sex}= 0, x_{smok} = 1$ 1.07               0.47              12.8              5.7
$x_{sex}= 0, x_{smok} = 0$ 2.58               1.14              31.0              13.7

The median life expectancies demonstrate what we would expect from the coefficients and the coding that:

* Life expectancies using treatment B can be expected to be shorter than those of treatment A.
* Women tend to have a shorter life expectancy than men.
* Smokers tend to have a shorter life expectancy than non-smokers.

# Question 2.4
Considering the statement that the hazard ratios of females to males and smokers to non-smokers are the same.


Null Hypothesis: $\mathlarger{\frac{h_{female}(t;\mathbf{x})}{h_{male}(t;\mathbf{x})} = \frac{h_{smoker}(t;\mathbf{x})}{h_{non-smoker}(t;\mathbf{x})}}$

$$
\begin{aligned}
\mathlarger{\frac{h_{female}(t;\mathbf{x})}{h_{male}(t;\mathbf{x})}} &= \mathlarger{\frac{h_0(t)exp\{\beta_1x_1 + \beta_2\times 1 + \beta_4x_4 \}}{h_0(t)exp\{ \beta_1x_1 + \beta_2\times 0 + \beta_4x_4 \}}} \\
\\
&= \mathlarger{\frac{h_o(t)exp\{\beta_2\times 1\}}{h_0(t)}} \\
&=exp\{\beta_2\}\\
&= exp\{-0.5328\} \\
&= 0.587 \\
\\
95\% \text{ CI } &= (exp\{\beta_2 - 1.96\times s.e(\beta_2)\}, exp\{\beta_2 + 1.96\times s.e(\beta_2)\})\\
&= (exp\{-0.52328 - 1.96\times 0.1911\}, exp\{-0.52328 + 1.96\times 0.1911\})\\
&= (0.41, 0.86) \\
\\
\\
\mathlarger{\frac{h_{smoker}(t;\mathbf{x})}{h_{non-smoker}(t;\mathbf{x})}} &= \mathlarger{\frac{h_0(t)exp\{\beta_1x_1 + \beta_2x_2 + \beta_4\times 1 \}}{h_0(t)exp\{ \beta_1x_1 + \beta_2x_2 + \beta_4\times 0 \}}} \\
\\
&= \mathlarger{\frac{h_o(t)exp\{\beta_4\times 1\}}{h_0(t)}} \\
&=exp\{\beta_4\}\\
&= exp\{-0.8821\} \\
&= 0.414 \\
\\
95\% \text{ CI } &= (exp\{\beta_4 - 1.96\times s.e(\beta_4)\}, exp\{\beta_4 + 1.96\times s.e(\beta_4)\})\\
&= (exp\{-0.8821 - 1.96\times 0.1915\}, exp\{-0.8821 + 1.96\times 0.1915\})\\
&= (0.28, 0.60) \\
\end{aligned}
$$
We can now compare if the hazard ratios are the same.
$$
\begin{aligned}
\text{let } \bar{x} &=  exp\{\beta_2\} - exp\{\beta_4\} \\
&= exp\{-0.5328\} - exp\{-0.8821\} \\
&= 0.173\\
\\
\text{let } \sigma &= \sqrt{s.e(\beta_2)^2 + s.e(\beta_4)^2}\\
&= \sqrt{0.1911^2 + 0.1915^2} \\
&= 0.27 \\
\\
95\% \text{ CI } &= \bar{x} \pm 1.96 \times \sigma \\
&= 0.173 \pm 1.96 \times 0.27\\
&= (-0.36, 0.70)
\end{aligned}
$$
Hence as the confidence interval covers zero there is no evidence to support a difference between the hazard ratios of females to males and the hazard ratios of smokers to non smokers.  The investigator was correct to suggest based on the evidence that the two hazards are the same.

