---
title: "MAS61002 Project Part B  \n Registration Number: 210138744"
geometry: margin=0.5cm
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(survival)
library(dplyr)
library(ggplot2)
data <- load("Data/E_PartB_data.RData")
```

# Question 1

# Question 1.1
```{r include=TRUE, results='asis', figures-side, fig.show="hold", out.width="50%"}
library(knitr) # for prettier tables
library(pander) #for adding pandoc headers
library(ggfortify) # so we can use fortify to create a datatable required for knitr
options(digits = 3) # let's keep output to sensible number of places
trialA <- q1dat %>% filter(drug == "A")
trialB <- q1dat %>% filter(drug == "B")
trialA.sv <- Surv(time=trialA$time, event=trialA$status, type="right")
trialASurv <- survfit(trialA.sv ~ 1, data = trialA)
tableA <- fortify(trialASurv) %>% rename(survival=surv, "lower 95% CI"=lower, "upper 95% CI"= upper) %>%
            select(1, 2, 3, 5, 6, 8, 7)
pandoc.header(list("Kaplan-Meier Estimate of Survivor Function for trial drug A"), level = 2)
print(kable(tableA))
trialB.sv <- Surv(time=trialB$time, event=trialB$status, type="right")
trialBSurv <- survfit(trialB.sv ~ 1, data = trialB)
tableB <- fortify(trialBSurv) %>% rename(survival=surv, "lower 95% CI"=lower, "upper 95% CI"= upper)%>%
            select(1, 2, 3, 5, 6, 8, 7)
pandoc.header(list("Kaplan-Meier Estimate of Survivor Function for trial drug B"), level = 2)
print(kable(tableB))

par(mar = c(4, 4, .1, .1))
plot(trialASurv, xlab ="months", ylab = "probablity of survival")
title("Kaplan-Meier  plot of trial A drug", line= -1 )
plot(trialBSurv, xlab ="months", ylab = "probablity of survival")
title( "Kaplan-Meier  plot of trial B drug", line= -1 )


```


# Question 1.2
Things to comments on: earliest death, average death, calculate rough quartiles. longest death. Look at error bounds. Number of people in the study. number who were censored.

# Question 1.3
Answer to Question 1.3 here

# Question 2

# Question 2.1
```{r include=TRUE}
lungcancer.sv <- Surv(time=q2dat$time, event=q2dat$stat, type="right")
model <- lungcancer.sv ~ as.factor(trea) + as.factor(sex) + as.factor(exer) + as.factor(smok) + age
lungcancer.regexp <- survreg(model, dist="exponential", data=q2dat)
summary(lungcancer.regexp)
```
Therefore the accelerated failure time model with an exponential failure time distribution and explanatory variables **x** is:

$$ \begin{aligned}
S(t;\mathbf{x}) &= exp\{{-t\: exp(-(\beta_0 + \beta_1x_{1} + \beta_2x_{2} + \beta_3x_{3} + \beta_4x_{4} + \beta_5x_{5}))}\}\\
&= exp\{{-t\: exp(-(\beta_0 + \beta_1x_{trea} + \beta_2x_{sex} + \beta_3x_{exer} + \beta_4x_{smok} + \beta_5x_{age}))}\}\\
&= exp\{{-t\: exp(-(0.5017 + 0.8144x_{trea} - 0.5328x_{sex} - 0.2566x_{exer} - 0.8821x_{smok} - 0.0113x_{age}))}\}\\
&= exp\{{-t\: exp(-0.5017 - 0.8144x_{trea} + 0.5328x_{sex} + 0.2566x_{exer} + 0.8821x_{smok} + 0.0113x_{age})}\}\\
\end{aligned}
$$

Variable     Coding
--------    -------------------------------------------------------------
sex         0 = male; 1 = female
exer        0 = some exercise; 1 = rarely exercise
smok        0 = not current smoker; 1 = current smoker
trea        0 = treatment A; 1 = treatment B
age         age of patient centred on 50 years (i.e. 60 years old is 10)
t           survival time (years)

Given the coding then the model will include the treatment variable for those on treatment B and exclude it for those on treatment A. However age is not significant in the model (p=0.15) so we will exclude that from the model. Let $S_a(t;\mathbf{x})$ be the model for treatment A and $S_b(t;\mathbf{x})$ the model for treatment B, then this gives:

$$ \begin{aligned}
S_a(t;\mathbf{x}) &= exp\{{-t\: exp(-0.5017 + 0.5328x_{sex} + 0.2566x_{exer} + 0.8821x_{smok})}\}\\
S_b(t;\mathbf{x}) &= exp\{{-t\: exp(-0.5017 - 0.8144x_{trea} + 0.5328x_{sex} + 0.2566x_{exer} + 0.8821x_{smok})}\}\\
\end{aligned}
$$

# Question 2.2

As $z = \beta_1 /(std. error) = 4.29$ and $4.29 > 1.96$ then there is overwhelming evidence that the treatment has an effect. Considering the proprtional hazards related to treatment A and B we know that $h(t; x |x_1=1)/h(t; x | x_1=0) = exp\:\beta_1$.  As $\beta_1 > 0$ then treatment B ($x_1 = 1$) increases the hazard relative to treatment A ($x_1 = 0$).

$$\begin{aligned}
\text{The 95}\% \text{ confidence interval for treatment }\beta_1\text{ is: }&= \hat{\beta_1} \pm 1.96 \times s.e(\hat{\beta_4}) \\
&= 0.8144 \pm 1.96 \times 0.1898 \\
&= (0.44, 1.19)
\end{aligned}
$$

The hazard function $h(t; \mathbf{x}) = exp\{\mathbf{B}'\mathbf{x}\}h_0(t)$ where $h_0(t) is the baseline hazard function.  Let $h_a(t; \mathbf{x})$ and $h_b(t; \mathbf{x})$ be the respective hazard functions of treatment A and treatment B, which are:
$$
\begin{aligned}
h_a(t;\mathbf{x}) &= h_0(t)exp\{\beta_2x_2 + \beta_3x_3 + \beta_4x_4  \}\\
h_b(t;\mathbf{x}) &= h_0(t)exp\{\beta_1\times 1 + \beta_2x_2 + \beta_3x_3 + \beta_4x_4 }\\
\end{aligned}
$$

Then the hazard ratio of treatment A versus treatment B is given by:
$$
\begin{aligned}
\frac{h_b(t;\mathbf{x})}{h_a(t;\mathbf{x})}  &= \frac{h_0(t)exp\{\beta_1\times 1 + \beta_2x_2 + \beta_3x_3 + \beta_4x_4 }}{h_0(t)exp\{ \beta_1\times 0 + \beta_2x_2 + \beta_3x_3 + \beta_4x_4 \}}\\
 &= \frac{h_o(t)exp\{\beta_1\times 1\}}{h_0(t)} \\
 &=exp\{\beta_1\}\\
 &= exp\{0.8144\} \\
 &= 2.26 \\
\end{aligned}
$$
The 95$\%$ confidence interval for the hazard ratio of treatment A versus treatment B ($exp\{\beta_1\}$) is given by:
$$
\begin{aligned}
95\% \text{ CI } &= (exp\{\beta_1 - 1.96*s.e(\beta_1)\}, exp\{\beta_1 + 1.96*s.e(\beta_1)\})\\
&= (exp\{0.8144 - 1.96*0.1898\}, exp\{0.8144 + 1.96*0.1898\})\\
&= (1.56, 3.28)
\end{aligned}
$$
Interpreting the confidence interval of (1.56, 3.28) means that at the $95\%$ confidence level that the hazard for patients on treatment B could be anywhere between just over one and half times and just over three and a quarter times that of the hazard for treatment A.

# Question 2.3
The median is calculated as follows where $median_a$ and $median_b$ be the median survival times for treatments A and B respectively. Note that age is not significant in the model so is removed.:
$$
\begin{aligned}
\text{median}_a &= log(2)exp\{\beta_0 + \beta_1\times x_1 + \beta_2\times x_2 + \beta_3\times x_3 + \beta_4\times x_4 } \\
&= log(2)exp\{\beta_0 + \beta_1\times x_{treat} + \beta_2\times x_{sex} + \beta_3\times x_{exer} + \beta_4\times x_{smok} \}\\
&= log(2)exp\{0.5017 + 0.8144\times 1 - 0.5328\times x_{sex} - 0.2566\times x_{exer} - 0.8821\times x_{smok} \}
\\
\text{median}_b &= log(2)exp\{\beta_0 + \beta_2\times x_{sex} + \beta_3\times x_{exer} + \beta_4\times x_{smok} \}\\
&= log(2)exp\{0.5017 - 0.5328\times x_{sex} - 0.2566\times x_{exer} - 0.8821\times x_{smok} \}
\end{aligned}
$$
The question asks "using the R output" therefore we must tabulate the possible answers.  Note that given the short median times in years, it was considered useful to list the median life expectancies in both years and months.

## Table of Median life expecancy for treatments A and B

Scenario                                 Median A (years)   Median B (years)  Median A (months) Median B (months)
---------------------------------------- ------------------ ----------------- ----------------- -----------------
$x_{sex}= 1, x_{exer} = 1, x_{smok} = 1$ 0.49                0.22              5.8               2.6
$x_{sex}= 1, x_{exer} = 1, x_{smok} = 0$ 1.17                0.52              14.1              6.2
$x_{sex}= 1, x_{exer} = 0, x_{smok} = 1$ 0.63                0.28              7.5               3.3
$x_{sex}= 1, x_{exer} = 0, x_{smok} = 0$ 1.52                0.67              18.2              8.1
$x_{sex}= 0, x_{exer} = 1, x_{smok} = 1$ 0.83                0.37              9.9               4.4
$x_{sex}= 0, x_{exer} = 1, x_{smok} = 0$ 2.00                0.89              24.0              10.6
$x_{sex}= 0, x_{exer} = 0, x_{smok} = 1$ 1.07                0.47              12.8              5.7
$x_{sex}= 0, x_{exer} = 1, x_{smok} = 0$ 2.59                1.15              31.0              13.7

# Question 2.4
Considering the statement that the hazard ratios of females to males and smokers to non-smokers are the same.  We need to assess which covariates are consistent across all groups and which are not, only exercise can be considered.


